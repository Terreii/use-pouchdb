<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Update docs · usePouchDB</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Up until now we don&#x27;t have any way to update our docs, i.e. mark our todos as done."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Update docs · usePouchDB"/><meta property="og:type" content="website"/><meta property="og:url" content="https://christopher-astfalk.de/use-pouchdb/"/><meta property="og:description" content="Up until now we don&#x27;t have any way to update our docs, i.e. mark our todos as done."/><meta property="og:image" content="https://christopher-astfalk.de/use-pouchdb/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://christopher-astfalk.de/use-pouchdb/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/use-pouchdb/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/use-pouchdb/js/scrollSpy.js"></script><link rel="stylesheet" href="/use-pouchdb/css/main.css"/><script src="/use-pouchdb/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/use-pouchdb/"><img class="logo" src="/use-pouchdb/img/favicon.ico" alt="usePouchDB"/><h2 class="headerTitleWithLogo">usePouchDB</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/use-pouchdb/docs/introduction/quick_start" target="_self">Docs</a></li><li class="siteNavGroupActive"><a href="/use-pouchdb/docs/api/provider" target="_self">API</a></li><li class=""><a href="/use-pouchdb/help" target="_self">Help</a></li><li class=""><a href="https://github.com/Terreii/use-pouchdb" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Basic Tutorial</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Introduction<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/introduction/quick_start">Quick Start</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/introduction/pouchdb_couchdb">PouchDB and CouchDB</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Basic Tutorial<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/intro">&#x27;Basic Tutorial: Intro&#x27;</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/setup">Setup</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/provider">Add the Provider</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/add-todo">Add Todos</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/list-all">List all Todos</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/use-pouchdb/docs/basics/update">Update docs</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/sync">Sync account</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/testing">Testing</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/basics/more">More</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">API<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/api/provider">Provider</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/api/use-pouch">usePouch</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/api/use-doc">useDoc</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/api/use-all-docs">useAllDocs</a></li><li class="navListItem"><a class="navItem" href="/use-pouchdb/docs/api/use-view">useView</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Update docs</h1></header><article><div><span><p>Up until now we don't have any way to update our docs, i.e. mark our todos as done.</p>
<p>Updating will be the job of our updated <code>&lt;Todo /&gt;</code> component:</p>
<pre><code class="hljs css language-jsx"><span class="hljs-comment">// Todo.js</span>
<span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { usePouch } <span class="hljs-keyword">from</span> <span class="hljs-string">'use-pouchdb'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Todo</span>(<span class="hljs-params">{ todo }</span>) </span>{
  <span class="hljs-keyword">const</span> db = usePouch()

  <span class="hljs-keyword">const</span> update = <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> db.get(todo._id)

    <span class="hljs-comment">// check if the UI state matches the state in the database.</span>
    <span class="hljs-keyword">if</span> (doc.done === todo.done) {
      doc.done = !doc.done <span class="hljs-comment">// Update the doc.</span>

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> db.put(doc) <span class="hljs-comment">// And put the new version into the database.</span>
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-keyword">if</span> (err.name === <span class="hljs-string">'conflict'</span>) {
          update() <span class="hljs-comment">// There was a conflict, try again.</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-built_in">console</span>.error(err) <span class="hljs-comment">// Handle other errors.</span>
        }
      }
    }
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.done}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{update}</span> /&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>'<span class="hljs-attr">todo-item__text</span>' + (<span class="hljs-attr">todo.done</span> ? ' <span class="hljs-attr">done</span>' <span class="hljs-attr">:</span> '')}&gt;</span>
        {todo.text}
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  )
}
</code></pre>
<p>Right away you might see some familiar functions, like <code>usePouch</code> and <code>db.put()</code>. But also the new <code>db.get()</code>.</p>
<p><a href="https://pouchdb.com/api.html#fetch_document"><code>db.get()</code></a> fetches a single document. All it needs is the <em>id</em> of
the doc. Like most methods of PouchDB, it too can fail. For example, if the doc doesn't exist, or you don't have
access to the database.</p>
<blockquote>
<p>The hook for fetching and subscribing to a single document is <code>useDoc</code>.</p>
</blockquote>
<p>In <code>update</code> we first <em>load</em> the document from the database. Then we <em>check</em> if the doc matches the UI state. And if
it does, we <em>update</em> the <code>done</code> field and <em>put</em> the new version into the database. If the update fails with a
<code>conflict</code> we <em>try again</em>.</p>
<p>That seems a little bit of an over engineered example. But remember PouchDB is a <em>distributed</em> system.</p>
<p><code>useAllDocs</code> takes some time between receiving a change update and re-rendering a component. In this time-frame the
user could have clicked. If the document did update, so that <code>done</code> has already the desired value, there is no need
in updating the document again. It would only add in used disk space and network traffic. Which the added bonus of
potential conflicts. Better check if we even need to update the doc.</p>
<p><code>db.get()</code> and <code>db.put()</code> also take their time. And if in this time-frame another change did sync, we get a
conflict! A conflict that throws right away: an <a href="https://pouchdb.com/guides/conflicts.html">immediate conflict</a>.</p>
<p>In this example we've chosen to handle the immediate conflict by simply trying again. We run <code>update</code> again, with
it still having a reverence to the old todo. It'll <code>get</code> the new version of the document, check if <code>done</code> has the
desired value, and update the new doc only if not.</p>
<p>Ok, yes. Those two conflict examples are <em>extremely</em> unlikely. In <em>this</em> example, you would probably be save
without error-handling. But in a typical app, you don't know how long something takes. What caching happens
between your data source and your update component. Those examples are there to guide you to the best
practice of PouchDB.</p>
<blockquote>
<p>This dance of conflict resolution is what allows PouchDB to sync! It requires you to handle conflicts.</p>
<p>In this example we know what the desired state of a doc should be: The last user interaction. There is also
almost no data lost if that assumption is wrong.</p>
<p>But you should generally follow the role: <strong>&quot;Last write wins&quot; means <em>losing</em> your users data!</strong></p>
</blockquote>
<blockquote>
<p>There are two types of conflicts: <strong>immediate conflicts</strong> and <strong>eventual conflicts</strong>. You can read more about
them in the <a href="https://pouchdb.com/guides/conflicts.html">PouchDB Conflicts guide</a>.</p>
</blockquote>
<p>Now that we can update todos. Let's filter them!</p>
<p>Update <code>&lt;TodoList /&gt;</code> to be similar to this:</p>
<pre><code class="hljs css language-jsx"><span class="hljs-comment">// TodoList.js</span>
<span class="hljs-keyword">import</span> React, { useState, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { useAllDocs } <span class="hljs-keyword">from</span> <span class="hljs-string">'use-pouchdb'</span>
<span class="hljs-keyword">import</span> Todo <span class="hljs-keyword">from</span> <span class="hljs-string">'./Todo'</span>
<span class="hljs-keyword">import</span> VisibilityFilters <span class="hljs-keyword">from</span> <span class="hljs-string">'./VisibilityFilters'</span>

<span class="hljs-keyword">const</span> filters = {
  <span class="hljs-attr">all</span>: <span class="hljs-string">'all'</span>,
  <span class="hljs-attr">completed</span>: <span class="hljs-string">'completed'</span>,
  <span class="hljs-attr">incomplete</span>: <span class="hljs-string">'incomplete'</span>,
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">TodoList</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> { rows, loading } = useAllDocs({
    <span class="hljs-attr">include_docs</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// Load all document bodies</span>
  })

  <span class="hljs-keyword">const</span> [filter, setFilter] = useState(filters.all)

  <span class="hljs-keyword">const</span> todos = useMemo(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">switch</span> (filter) {
      <span class="hljs-keyword">case</span> filters.completed:
        <span class="hljs-keyword">return</span> rows.filter(<span class="hljs-function"><span class="hljs-params">row</span> =&gt;</span> row.doc.done)

      <span class="hljs-keyword">case</span> filters.incomplete:
        <span class="hljs-keyword">return</span> rows.filter(<span class="hljs-function"><span class="hljs-params">row</span> =&gt;</span> !row.doc.done)

      <span class="hljs-keyword">case</span> filters.all:
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> rows
    }
  }, [rows, filter])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-list"</span>&gt;</span>
        {(todos &amp;&amp; todos.length) || loading
          ? todos.map(todo =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">Todo</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.key}</span> <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo.doc}</span> /&gt;</span>)
          : 'No todos, yay!'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">VisibilityFilters</span>
        <span class="hljs-attr">current</span>=<span class="hljs-string">{filter}</span>
        <span class="hljs-attr">options</span>=<span class="hljs-string">{filters}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{setFilter}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>And the <code>&lt;VisibilityFilters /&gt;</code> component:</p>
<pre><code class="hljs css language-jsx"><span class="hljs-comment">// VisibilityFilters.js</span>
<span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">VisibilityFilters</span>(<span class="hljs-params">{ current, options, onChange }</span>) </span>{
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"visibility-filters"</span>&gt;</span>
      {Object.entries(options).map(([key, value]) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{key}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"radio"</span>
            <span class="hljs-attr">name</span>=<span class="hljs-string">"visibility-filters"</span>
            <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>
            <span class="hljs-attr">checked</span>=<span class="hljs-string">{value</span> === <span class="hljs-string">current}</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{e</span> =&gt;</span> {
              onChange(value)
            }}
          /&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>That would be all. We now can filter todos! Show all or by completion state.</p>
<p>But there is one more thing! Open another tab (or better: a new window) with our Todo-App.</p>
<p>If you are not in private browsing all your todos should already be there! Now update them.</p>
<p><img src="../../img/oh_yes_indeed.gif" alt="Disney Marvel's Loki says &quot;Oh yes&quot;"></p>
<p>Your todos sync between your tabs, while the filter state is local!</p>
<p>Next: we going to implement syncing between different browsers/devices.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/use-pouchdb/docs/basics/list-all"><span class="arrow-prev">← </span><span>List all Todos</span></a><a class="docs-next button" href="/use-pouchdb/docs/basics/sync"><span>Sync account</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/use-pouchdb/" class="nav-home"><img src="/use-pouchdb/img/favicon.ico" alt="usePouchDB" width="66" height="58"/></a><div><h5>Docs</h5><a href="/use-pouchdb/docs/introduction/quick_start">Getting Started</a><a href="/use-pouchdb/docs/api/provider">API Reference</a></div><div><h5>Contact</h5><a href="https://christopher-astfalk.de/">Blog</a><a href="https://github.com/Terreii/use-pouchdb" rel="noreferrer noopener">GitHub</a><a class="github-button" href="https://github.com/Terreii/use-pouchdb" data-icon="octicon-star" data-count-href="/Terreii/use-pouchdb/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="../impressum.html">Impressum</a></div></div></section><section class="copyright">Copyright © 2020 Christopher Astfalk</section></footer></div></body></html>